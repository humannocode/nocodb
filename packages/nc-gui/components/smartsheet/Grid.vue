<script lang="ts" setup>
import type { ColumnReqType, ColumnType, TableType, ViewType } from 'nocodb-sdk'
import { UITypes, isVirtualCol } from 'nocodb-sdk'
import { jsPDF } from 'jspdf'
import {
  ActiveViewInj,
  CellUrlDisableOverlayInj,
  ChangePageInj,
  FieldsInj,
  IsFormInj,
  IsGalleryInj,
  IsGridInj,
  IsLockedInj,
  MetaInj,
  NavigateDir,
  OpenNewRecordFormHookInj,
  PaginationDataInj,
  ReadonlyInj,
  ReloadRowDataHookInj,
  ReloadViewDataHookInj,
  SmartsheetStoreEvents,
  computed,
  createEventHook,
  enumColor,
  extractPkFromRow,
  inject,
  isColumnRequiredAndNull,
  isDrawerOrModalExist,
  isImage,
  isMac,
  message,
  onBeforeUnmount,
  onClickOutside,
  onMounted,
  provide,
  ref,
  useEventListener,
  useGridViewColumnWidth,
  useI18n,
  useMetas,
  useMultiSelect,
  useNuxtApp,
  useRoles,
  useRoute,
  useSmartsheetStoreOrThrow,
  useUIPermission,
  useViewData,
  watch,
} from '#imports'

import type { Row } from '~/lib'

const { t } = useI18n()

const meta = inject(MetaInj, ref())

const view = inject(ActiveViewInj, ref())

const { $e } = useNuxtApp()

// keep a root fields variable and will get modified from
// fields menu and get used in grid and gallery
const fields = inject(FieldsInj, ref([]))
const readOnly = inject(ReadonlyInj, ref(false))
const isLocked = inject(IsLockedInj, ref(false))

const reloadViewDataHook = inject(ReloadViewDataHookInj, createEventHook())
const openNewRecordFormHook = inject(OpenNewRecordFormHookInj, createEventHook())

const { hasRole } = useRoles()
const { isUIAllowed } = useUIPermission()
const hasEditPermission = $computed(() => isUIAllowed('xcDatatableEditable'))

const route = useRoute()
const router = useRouter()

// todo: get from parent ( inject or use prop )
const isView = false

let editEnabled = $ref(false)

const { xWhere, isPkAvail, isSqlView, eventBus } = useSmartsheetStoreOrThrow()

const visibleColLength = $computed(() => fields.value?.length)

const addColumnDropdown = ref(false)

const _contextMenu = ref(false)
const contextMenu = computed({
  get: () => _contextMenu.value,
  set: (val) => {
    if (hasEditPermission) {
      _contextMenu.value = val
    }
  },
})

const routeQuery = $computed(() => route.query as Record<string, string>)
const contextMenuTarget = ref<{ row: number; col: number } | null>(null)
const expandedFormDlg = ref(false)
const expandedFormRow = ref<Row>()
const expandedFormRowState = ref<Record<string, any>>()
const tbodyEl = ref<HTMLElement>()
const gridWrapper = ref<HTMLElement>()
const tableHead = ref<HTMLElement>()

const isAddingColumnAllowed = !readOnly.value && !isLocked.value && isUIAllowed('add-column') && !isSqlView.value

const isAddingEmptyRowAllowed = !isView && !isLocked.value && hasEditPermission && !isSqlView.value

const {
  isLoading,
  loadData,
  paginationData,
  formattedData: data,
  updateOrSaveRow,
  changePage,
  addEmptyRow,
  deleteRow,
  deleteSelectedRows,
  selectedAllRecords,
  removeRowIfNew,
  navigateToSiblingRow,
} = useViewData(meta, view, xWhere)

const { getMeta } = useMetas()

const { loadGridViewColumns, updateWidth, resizingColWidth, resizingCol } = useGridViewColumnWidth(view)

const FOO_EXAMPLE_QRCODE_BASE64 =
  'data:image/png;base64,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'

const {
  // showSystemFields,
  sortedAndFilteredFields,
  // fields,
  filteredFieldList,
  // filterQuery,
  // showAll,
  // hideAll,
  // saveOrUpdate,
  // metaColumnById,
  // loadViewColumns,
} = useViewColumns(view, meta)

const generatePdfForSelectedRows = () => {
  const selectedRows = data.value.filter((row) => row.rowMeta.selected)
  if (selectedRows.length) {
    // alert(JSON.stringify(selectedRows))

    // Default export is a4 paper, portrait, using millimeters for units
    const doc = new jsPDF()

    // console.log('FOO')
    // console.log(JSON.stringify(filteredFieldList.value))

    selectedRows.forEach((row, idx) => {
      if (idx > 0) {
        doc.addPage()
      }
      // doc.table()
      // view.value?.

      // view?.value.fiel
      // const orderedCols = meta.value?.columns?.sort((col) => col.order || 0)
      // alert(JSON.stringify(orderedCols?.map((col) => col.title)))

      sortedAndFilteredFields.value
        ?.filter((col) => filteredFieldList.value.map((el) => el.title).includes(col.title || ''))
        .forEach((col, colIdx) => {
          // col.or
          const yPos = 10 + colIdx * 60
          const cellValue = row.row[col.title!]
          // doc.setFont('Arial', undefined, 25)
          doc.text(col.title!, 10, yPos)

          switch (col.uidt) {
            case UITypes.Attachment: {
              alert(JSON.stringify(cellValue))
              const attachmentsObjects = JSON.parse(cellValue) as any[]
              const imgAttachments = attachmentsObjects.filter((attObj) => isImage(attObj.attObj, attObj.mimetype))
              const firstImgAttachment = imgAttachments[0]
              if (!firstImgAttachment) {
                break
              }
              doc.addImage(FOO_EXAMPLE_QRCODE_BASE64, 'png', 10, yPos + 10, 40, 40)
              // alert('Attachment')
              break
            }
            default: {
              // doc.setFont('Arial', undefined, 20)
              doc.text(`${cellValue}`, 10, yPos + 10)
              break
            }
          }
        })
    })

    // doc.addPage()
    // doc.text('Hello world!', 10, 10)
    // const dateTimeStrForPdfFileName
    const pdfFileName = `${meta.value?.title || 'table'}_${view.value?.title || 'view'}__${selectedRows.length}_rows__.pdf`
    doc.save(pdfFileName)

    // $e.emit(SmartsheetStoreEvents.GENERATE_PDF, {
    //   meta: meta.value,
    //   view: view.value,
    //   rows: selectedRows,
    // })
  } else {
    message.error(t('Please select at least one row'))
  }
}

const getContainerScrollForElement = (
  el: HTMLElement,
  container: HTMLElement,
  offset?: {
    top?: number
    bottom?: number
    left?: number
    right?: number
  },
) => {
  const childPos = el.getBoundingClientRect()
  const parentPos = container.getBoundingClientRect()
  const relativePos = {
    top: childPos.top - parentPos.top,
    right: childPos.right - parentPos.right,
    bottom: childPos.bottom - parentPos.bottom,
    left: childPos.left - parentPos.left,
  }

  const scroll = {
    top: 0,
    left: 0,
  }

  /*
   * If the element is to the right of the container, scroll right (positive)
   * If the element is to the left of the container, scroll left (negative)
   */
  scroll.left =
    relativePos.right + (offset?.right || 0) > 0
      ? container.scrollLeft + relativePos.right + (offset?.right || 0)
      : relativePos.left - (offset?.left || 0) < 0
      ? container.scrollLeft + relativePos.left - (offset?.left || 0)
      : container.scrollLeft

  /*
   * If the element is below the container, scroll down (positive)
   * If the element is above the container, scroll up (negative)
   */
  scroll.top =
    relativePos.bottom + (offset?.bottom || 0) > 0
      ? container.scrollTop + relativePos.bottom + (offset?.bottom || 0)
      : relativePos.top - (offset?.top || 0) < 0
      ? container.scrollTop + relativePos.top - (offset?.top || 0)
      : container.scrollTop

  return scroll
}

const { isCellSelected, activeCell, handleMouseDown, handleMouseOver, handleCellClick, clearSelectedRange, copyValue } =
  useMultiSelect(
    meta,
    fields,
    data,
    $$(editEnabled),
    isPkAvail,
    clearCell,
    makeEditable,
    scrollToCell,
    (e: KeyboardEvent) => {
      // ignore navigating if picker(Date, Time, DateTime, Year)
      // or single/multi select options is open
      const activePickerOrDropdownEl = document.querySelector(
        '.nc-picker-datetime.active,.nc-dropdown-single-select-cell.active,.nc-dropdown-multi-select-cell.active,.nc-picker-date.active,.nc-picker-year.active,.nc-picker-time.active',
      )
      if (activePickerOrDropdownEl) {
        e.preventDefault()
        return true
      }

      // skip keyboard event handling if there is a drawer / modal
      if (isDrawerOrModalExist()) {
        return true
      }

      const cmdOrCtrl = isMac() ? e.metaKey : e.ctrlKey
      const altOrOptionKey = e.altKey
      if (e.key === ' ') {
        if (activeCell.row != null && !editEnabled && hasEditPermission) {
          e.preventDefault()
          clearSelectedRange()
          const row = data.value[activeCell.row]
          expandForm(row)
          return true
        }
      } else if (e.key === 'Escape') {
        if (editEnabled) {
          editEnabled = false
          return true
        }
      } else if (e.key === 'Enter') {
        if (e.shiftKey) {
          // add a line break for types like LongText / JSON
          return true
        }
        if (editEnabled) {
          editEnabled = false
          return true
        }
      }

      if (cmdOrCtrl) {
        switch (e.key) {
          case 'ArrowUp':
            e.preventDefault()
            clearSelectedRange()
            activeCell.row = 0
            activeCell.col = activeCell.col ?? 0
            scrollToCell?.()
            editEnabled = false
            return true
          case 'ArrowDown':
            e.preventDefault()
            clearSelectedRange()
            activeCell.row = data.value.length - 1
            activeCell.col = activeCell.col ?? 0
            scrollToCell?.()
            editEnabled = false
            return true
          case 'ArrowRight':
            e.preventDefault()
            clearSelectedRange()
            activeCell.row = activeCell.row ?? 0
            activeCell.col = fields.value?.length - 1
            scrollToCell?.()
            editEnabled = false
            return true
          case 'ArrowLeft':
            e.preventDefault()
            clearSelectedRange()
            activeCell.row = activeCell.row ?? 0
            activeCell.col = 0
            scrollToCell?.()
            editEnabled = false
            return true
        }
      }

      if (altOrOptionKey) {
        switch (e.keyCode) {
          case 82: {
            // ALT + R
            if (isAddingEmptyRowAllowed) {
              $e('c:shortcut', { key: 'ALT + R' })
              addEmptyRow()
            }
            break
          }
          case 67: {
            // ALT + C
            if (isAddingColumnAllowed) {
              $e('c:shortcut', { key: 'ALT + C' })
              addColumnDropdown.value = true
            }
            break
          }
        }
      }
    },
    async (ctx: { row: number; col?: number; updatedColumnTitle?: string }) => {
      const rowObj = data.value[ctx.row]
      const columnObj = ctx.col !== undefined ? fields.value[ctx.col] : null

      if (!ctx.updatedColumnTitle && isVirtualCol(columnObj)) {
        return
      }

      // update/save cell value
      await updateOrSaveRow(rowObj, ctx.updatedColumnTitle || columnObj.title)
    },
  )

function scrollToCell(row?: number | null, col?: number | null) {
  row = row ?? activeCell.row
  col = col ?? activeCell.col

  if (row !== null && col !== null) {
    // get active cell
    const rows = tbodyEl.value?.querySelectorAll('tr')
    const cols = rows?.[row].querySelectorAll('td')
    const td = cols?.[col === 0 ? 0 : col + 1]

    if (!td || !gridWrapper.value) return

    const { height: headerHeight } = tableHead.value!.getBoundingClientRect()
    const tdScroll = getContainerScrollForElement(td, gridWrapper.value, { top: headerHeight, bottom: 9, right: 9 })

    if (rows && row === rows.length - 2) {
      // if last row make 'Add New Row' visible
      gridWrapper.value.scrollTo({
        top: gridWrapper.value.scrollHeight,
        left:
          cols && col === cols.length - 2 // if corner cell
            ? gridWrapper.value.scrollWidth
            : tdScroll.left,
        behavior: 'smooth',
      })
      return
    }

    if (cols && col === cols.length - 2) {
      // if last column make 'Add New Column' visible
      gridWrapper.value.scrollTo({
        top: tdScroll.top,
        left: gridWrapper.value.scrollWidth,
        behavior: 'smooth',
      })
      return
    }

    // scroll into the active cell
    gridWrapper.value.scrollTo({
      top: tdScroll.top,
      left: tdScroll.left,
      behavior: 'smooth',
    })
  }
}

onMounted(loadGridViewColumns)

provide(IsFormInj, ref(false))

provide(IsGalleryInj, ref(false))

provide(IsGridInj, ref(true))

provide(PaginationDataInj, paginationData)

provide(ChangePageInj, changePage)

const disableUrlOverlay = ref(false)
provide(CellUrlDisableOverlayInj, disableUrlOverlay)

const showLoading = ref(true)

const skipRowRemovalOnCancel = ref(false)

function expandForm(row: Row, state?: Record<string, any>, fromToolbar = false) {
  const rowId = extractPkFromRow(row.row, meta.value?.columns as ColumnType[])

  if (rowId) {
    router.push({
      query: {
        ...routeQuery,
        rowId,
      },
    })
  } else {
    expandedFormRow.value = row
    expandedFormRowState.value = state
    expandedFormDlg.value = true
    skipRowRemovalOnCancel.value = !fromToolbar
  }
}

const onresize = (colID: string, event: any) => {
  updateWidth(colID, event.detail)
}

const onXcResizing = (cn: string, event: any) => {
  resizingCol.value = cn
  resizingColWidth.value = event.detail
}

defineExpose({
  loadData,
})

// reset context menu target on hide
watch(contextMenu, () => {
  if (!contextMenu.value) {
    contextMenuTarget.value = null
  }
})

const rowRefs = $ref<any[]>()

async function clearCell(ctx: { row: number; col: number } | null, skipUpdate = false) {
  if (
    !ctx ||
    !hasEditPermission ||
    (fields.value[ctx.col].uidt !== UITypes.LinkToAnotherRecord && isVirtualCol(fields.value[ctx.col]))
  )
    return

  const rowObj = data.value[ctx.row]
  const columnObj = fields.value[ctx.col]

  if (isVirtualCol(columnObj)) {
    await rowRefs[ctx.row]!.clearLTARCell(columnObj)
    return
  }

  rowObj.row[columnObj.title] = null

  if (!skipUpdate) {
    // update/save cell value
    await updateOrSaveRow(rowObj, columnObj.title)
  }
}

function makeEditable(row: Row, col: ColumnType) {
  if (!hasEditPermission || editEnabled || isView) {
    return
  }

  if (!isPkAvail.value && !row.rowMeta.new) {
    // Update not allowed for table which doesn't have primary Key
    message.info(t('msg.info.updateNotAllowedWithoutPK'))
    return
  }

  if (col.ai) {
    // Auto Increment field is not editable
    message.info(t('msg.info.autoIncFieldNotEditable'))
    return
  }

  if (col.pk && !row.rowMeta.new) {
    // Editing primary key not supported
    message.info(t('msg.info.editingPKnotSupported'))
    return
  }

  return (editEnabled = true)
}

/** handle keypress events */
useEventListener(document, 'keyup', async (e: KeyboardEvent) => {
  if (e.key === 'Alt') {
    disableUrlOverlay.value = false
  }
})

/** On clicking outside of table reset active cell  */
const smartTable = ref(null)

onClickOutside(smartTable, (e) => {
  // do nothing if context menu was open
  if (contextMenu.value) return

  if (activeCell.row === null || activeCell.col === null) return

  const activeCol = fields.value[activeCell.col]

  if (editEnabled && (isVirtualCol(activeCol) || activeCol.uidt === UITypes.JSON)) return

  // ignore unselecting if clicked inside or on the picker(Date, Time, DateTime, Year)
  // or single/multi select options
  const activePickerOrDropdownEl = document.querySelector(
    '.nc-picker-datetime.active,.nc-dropdown-single-select-cell.active,.nc-dropdown-multi-select-cell.active,.nc-picker-date.active,.nc-picker-year.active,.nc-picker-time.active',
  )
  if (
    e.target &&
    activePickerOrDropdownEl &&
    (activePickerOrDropdownEl === e.target || activePickerOrDropdownEl?.contains(e.target as Element))
  )
    return

  // skip if drawer / modal is active
  if (isDrawerOrModalExist()) {
    return
  }

  clearSelectedRange()
  activeCell.row = null
  activeCell.col = null
})

const onNavigate = (dir: NavigateDir) => {
  if (activeCell.row === null || activeCell.col === null) return

  editEnabled = false
  clearSelectedRange()

  switch (dir) {
    case NavigateDir.NEXT:
      if (activeCell.row < data.value.length - 1) {
        activeCell.row++
      } else {
        addEmptyRow()
        activeCell.row++
      }
      break
    case NavigateDir.PREV:
      if (activeCell.row > 0) {
        activeCell.row--
      }
      break
  }
}

const showContextMenu = (e: MouseEvent, target?: { row: number; col: number }) => {
  if (isSqlView.value) return
  e.preventDefault()
  if (target) {
    contextMenuTarget.value = target
  }
}

const saveOrUpdateRecords = async (args: { metaValue?: TableType; viewMetaValue?: ViewType; data?: any } = {}) => {
  let index = -1
  for (const currentRow of args.data || data.value) {
    index++
    /** if new record save row and save the LTAR cells */
    if (currentRow.rowMeta.new) {
      const syncLTARRefs = rowRefs[index]!.syncLTARRefs
      const savedRow = await updateOrSaveRow(currentRow, '', {}, args)
      await syncLTARRefs(savedRow, args)
      currentRow.rowMeta.changed = false
      continue
    }
    /** if existing row check updated cell and invoke update method */
    if (currentRow.rowMeta.changed) {
      currentRow.rowMeta.changed = false
      for (const field of (args.metaValue || meta.value)?.columns ?? []) {
        if (isVirtualCol(field)) continue
        if (field.title! in currentRow.row && currentRow.row[field.title!] !== currentRow.oldRow[field.title!]) {
          await updateOrSaveRow(currentRow, field.title!, {}, args)
        }
      }
    }
  }
}

async function reloadViewDataHandler(shouldShowLoading: boolean | void) {
  // set value if spinner should be hidden
  showLoading.value = !!shouldShowLoading
  await loadData()
  // reset to default (showing spinner on load)
  showLoading.value = true
}

async function openNewRecordHandler() {
  const newRow = addEmptyRow()
  expandForm(newRow, undefined, true)
}

reloadViewDataHook?.on(reloadViewDataHandler)
openNewRecordFormHook?.on(openNewRecordHandler)

onBeforeUnmount(() => {
  /** save/update records before unmounting the component */
  saveOrUpdateRecords()

  // reset hooks
  reloadViewDataHook?.off(reloadViewDataHandler)
  openNewRecordFormHook?.off(openNewRecordHandler)
})

const expandedFormOnRowIdDlg = computed({
  get() {
    return !!routeQuery.rowId
  },
  set(val) {
    if (!val)
      router.push({
        query: {
          ...routeQuery,
          rowId: undefined,
        },
      })
  },
})

// reload table data reload hook as fallback to rowdatareload
provide(ReloadRowDataHookInj, reloadViewDataHook)

// trigger initial data load in grid
// reloadViewDataHook.trigger()

const switchingTab = ref(false)

watch(
  view,
  async (next, old) => {
    try {
      if (next && next.id !== old?.id) {
        switchingTab.value = true
        // whenever tab changes or view changes save any unsaved data
        if (old?.id) {
          const oldMeta = await getMeta(old.fk_model_id!)
          if (oldMeta) {
            await saveOrUpdateRecords({
              viewMetaValue: old,
              metaValue: oldMeta as TableType,
              data: data.value,
            })
          }
        }
        await loadData()
      }
    } catch (e) {
      console.log(e)
    } finally {
      switchingTab.value = false
    }
  },
  { immediate: true },
)

const columnOrder = ref<Pick<ColumnReqType, 'column_order'> | null>(null)

eventBus.on(async (event, payload) => {
  if (event === SmartsheetStoreEvents.FIELD_ADD) {
    columnOrder.value = payload
    addColumnDropdown.value = true
  }
})

const closeAddColumnDropdown = () => {
  columnOrder.value = null
  addColumnDropdown.value = false
}
</script>

<template>
  <div class="relative flex flex-col h-full min-h-0 w-full" data-testid="nc-grid-wrapper">
    <general-overlay :model-value="isLoading" inline transition class="!bg-opacity-15" data-testid="grid-load-spinner">
      <div class="flex items-center justify-center h-full w-full !bg-white !bg-opacity-85 z-1000">
        <a-spin size="large" />
      </div>
    </general-overlay>

    <div ref="gridWrapper" class="nc-grid-wrapper min-h-0 flex-1 scrollbar-thin-dull">
      <a-dropdown
        v-model:visible="contextMenu"
        :trigger="isSqlView ? [] : ['contextmenu']"
        overlay-class-name="nc-dropdown-grid-context-menu"
      >
        <table
          ref="smartTable"
          class="xc-row-table nc-grid backgroundColorDefault !h-auto bg-white"
          @contextmenu="showContextMenu"
        >
          <thead ref="tableHead">
            <tr class="nc-grid-header border-1 bg-gray-100 sticky top[-1px]">
              <th data-testid="grid-id-column">
                <div class="w-full h-full bg-gray-100 flex min-w-[70px] pl-5 pr-1 items-center" data-testid="nc-check-all">
                  <template v-if="!readOnly">
                    <div class="nc-no-label text-gray-500" :class="{ hidden: selectedAllRecords }">#</div>
                    <div
                      :class="{ hidden: !selectedAllRecords, flex: selectedAllRecords }"
                      class="nc-check-all w-full items-center"
                    >
                      <a-checkbox v-model:checked="selectedAllRecords" />

                      <span class="flex-1" />
                    </div>
                  </template>
                  <template v-else>
                    <div class="text-gray-500">#</div>
                  </template>
                </div>
              </th>
              <th
                v-for="col in fields"
                :key="col.title"
                v-xc-ver-resize
                :data-col="col.id"
                :data-title="col.title"
                @xcresize="onresize(col.id, $event)"
                @xcresizing="onXcResizing(col.title, $event)"
                @xcresized="resizingCol = null"
              >
                <div class="w-full h-full bg-gray-100 flex items-center">
                  <LazySmartsheetHeaderVirtualCell v-if="isVirtualCol(col)" :column="col" :hide-menu="readOnly" />

                  <LazySmartsheetHeaderCell v-else :column="col" :hide-menu="readOnly" />
                </div>
              </th>
              <th
                v-if="isAddingColumnAllowed"
                v-e="['c:column:add']"
                class="cursor-pointer"
                @click.stop="addColumnDropdown = true"
              >
                <a-dropdown
                  v-model:visible="addColumnDropdown"
                  :trigger="['click']"
                  overlay-class-name="nc-dropdown-grid-add-column"
                >
                  <div class="h-full w-[60px] flex items-center justify-center">
                    <MdiPlus class="text-sm nc-column-add" />
                  </div>

                  <template #overlay>
                    <SmartsheetColumnEditOrAddProvider
                      v-if="addColumnDropdown"
                      :column-position="columnOrder"
                      @submit="closeAddColumnDropdown"
                      @cancel="closeAddColumnDropdown"
                      @click.stop
                      @keydown.stop
                    />
                  </template>
                </a-dropdown>
              </th>
            </tr>
          </thead>
          <tbody ref="tbodyEl">
            <LazySmartsheetRow v-for="(row, rowIndex) of data" ref="rowRefs" :key="rowIndex" :row="row">
              <template #default="{ state }">
                <tr class="nc-grid-row" :data-testid="`grid-row-${rowIndex}`">
                  <td key="row-index" class="caption nc-grid-cell pl-5 pr-1" :data-testid="`cell-Id-${rowIndex}`">
                    <div class="items-center flex gap-1 min-w-[55px]">
                      <div
                        v-if="!readOnly || !isLocked"
                        class="nc-row-no text-xs text-gray-500"
                        :class="{ toggle: !readOnly, hidden: row.rowMeta.selected }"
                      >
                        {{ rowIndex + 1 }}
                      </div>
                      <div
                        v-if="!readOnly"
                        :class="{ hidden: !row.rowMeta.selected, flex: row.rowMeta.selected }"
                        class="nc-row-expand-and-checkbox"
                      >
                        <a-checkbox v-model:checked="row.rowMeta.selected" />
                      </div>
                      <span class="flex-1" />

                      <div
                        v-if="!readOnly || hasRole('commenter', true) || hasRole('viewer', true)"
                        class="nc-expand"
                        :data-testid="`nc-expand-${rowIndex}`"
                        :class="{ 'nc-comment': row.rowMeta?.commentCount }"
                      >
                        <a-spin
                          v-if="row.rowMeta.saving"
                          class="!flex items-center"
                          :data-testid="`row-save-spinner-${rowIndex}`"
                        />
                        <template v-else>
                          <span
                            v-if="row.rowMeta?.commentCount"
                            class="py-1 px-3 rounded-full text-xs cursor-pointer select-none transform hover:(scale-110)"
                            :style="{ backgroundColor: enumColor.light[row.rowMeta.commentCount % enumColor.light.length] }"
                            @click="expandForm(row, state)"
                          >
                            {{ row.rowMeta.commentCount }}
                          </span>
                          <div
                            v-else
                            class="cursor-pointer flex items-center border-1 active:ring rounded p-1 hover:(bg-primary bg-opacity-10)"
                          >
                            <MdiArrowExpand
                              v-e="['c:row-expand']"
                              class="select-none transform hover:(text-accent scale-120) nc-row-expand"
                              @click="expandForm(row, state)"
                            />
                          </div>
                        </template>
                      </div>
                    </div>
                  </td>
                  <SmartsheetTableDataCell
                    v-for="(columnObj, colIndex) of fields"
                    :key="columnObj.id"
                    class="cell relative cursor-pointer nc-grid-cell"
                    :class="{
                      'active': hasEditPermission && isCellSelected(rowIndex, colIndex),
                      'nc-required-cell': isColumnRequiredAndNull(columnObj, row.row),
                    }"
                    :data-testid="`cell-${columnObj.title}-${rowIndex}`"
                    :data-key="rowIndex + columnObj.id"
                    :data-col="columnObj.id"
                    :data-title="columnObj.title"
                    @mousedown="handleMouseDown($event, rowIndex, colIndex)"
                    @mouseover="handleMouseOver(rowIndex, colIndex)"
                    @click="handleCellClick($event, rowIndex, colIndex)"
                    @dblclick="makeEditable(row, columnObj)"
                    @contextmenu="showContextMenu($event, { row: rowIndex, col: colIndex })"
                  >
                    <div v-if="!switchingTab" class="w-full h-full">
                      <LazySmartsheetVirtualCell
                        v-if="isVirtualCol(columnObj)"
                        v-model="row.row[columnObj.title]"
                        :column="columnObj"
                        :active="activeCell.col === colIndex && activeCell.row === rowIndex"
                        :row="row"
                        :read-only="readOnly"
                        @navigate="onNavigate"
                      />

                      <LazySmartsheetCell
                        v-else
                        v-model="row.row[columnObj.title]"
                        :column="columnObj"
                        :edit-enabled="
                          !!hasEditPermission && !!editEnabled && activeCell.col === colIndex && activeCell.row === rowIndex
                        "
                        :row-index="rowIndex"
                        :active="activeCell.col === colIndex && activeCell.row === rowIndex"
                        :read-only="readOnly"
                        @update:edit-enabled="editEnabled = $event"
                        @save="updateOrSaveRow(row, columnObj.title, state)"
                        @navigate="onNavigate"
                        @cancel="editEnabled = false"
                      />
                    </div>
                  </SmartsheetTableDataCell>
                </tr>
              </template>
            </LazySmartsheetRow>

            <tr v-if="isAddingEmptyRowAllowed">
              <td
                v-e="['c:row:add:grid-bottom']"
                :colspan="visibleColLength + 1"
                class="text-left pointer nc-grid-add-new-cell cursor-pointer"
                @click="addEmptyRow()"
              >
                <div class="px-2 w-full flex items-center text-gray-500">
                  <MdiPlus class="text-pint-500 text-xs ml-2 text-primary" />

                  <span class="ml-1">
                    {{ $t('activity.addRow') }}
                  </span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <template v-if="!isLocked && hasEditPermission" #overlay>
          <a-menu class="shadow !rounded !py-0" @click="contextMenu = false">
            <a-menu-item v-if="contextMenuTarget" @click="deleteRow(contextMenuTarget.row)">
              <div v-e="['a:row:delete']" class="nc-project-menu-item">
                <!-- Delete Row -->
                {{ $t('activity.deleteRow') }}
              </div>
            </a-menu-item>

            <a-menu-item @click="generatePdfForSelectedRows">
              <div v-e="['a:row:delete-bulk']" class="nc-project-menu-item">
                <!-- Generate PDF for Selected Rows -->
                {{ $t('activity.generatePdfForSelectedRows') }}
              </div>
            </a-menu-item>

            <a-menu-item @click="deleteSelectedRows">
              <div v-e="['a:row:delete-bulk']" class="nc-project-menu-item">
                <!-- Delete Selected Rows -->
                {{ $t('activity.deleteSelectedRow') }}
              </div>
            </a-menu-item>

            <!--            Clear cell -->
            <a-menu-item
              v-if="
                contextMenuTarget &&
                (fields[contextMenuTarget.col].uidt === UITypes.LinkToAnotherRecord ||
                  !isVirtualCol(fields[contextMenuTarget.col]))
              "
              @click="clearCell(contextMenuTarget)"
            >
              <div v-e="['a:row:clear']" class="nc-project-menu-item">{{ $t('activity.clearCell') }}</div>
            </a-menu-item>

            <a-menu-item v-if="contextMenuTarget" @click="addEmptyRow(contextMenuTarget.row + 1)">
              <div v-e="['a:row:insert']" class="nc-project-menu-item">
                <!-- Insert New Row -->
                {{ $t('activity.insertRow') }}
              </div>
            </a-menu-item>

            <a-menu-item v-if="contextMenuTarget" data-testid="context-menu-item-copy" @click="copyValue(contextMenuTarget)">
              <div v-e="['a:row:copy']" class="nc-project-menu-item">
                <!-- Copy -->
                {{ $t('general.copy') }}
              </div>
            </a-menu-item>
          </a-menu>
        </template>
      </a-dropdown>
    </div>

    <LazySmartsheetPagination />

    <Suspense>
      <LazySmartsheetExpandedForm
        v-if="expandedFormRow && expandedFormDlg"
        v-model="expandedFormDlg"
        :row="expandedFormRow"
        :state="expandedFormRowState"
        :meta="meta"
        :view="view"
        @update:model-value="!skipRowRemovalOnCancel && removeRowIfNew(expandedFormRow)"
      />
    </Suspense>

    <Suspense>
      <LazySmartsheetExpandedForm
        v-if="expandedFormOnRowIdDlg"
        :key="routeQuery.rowId"
        v-model="expandedFormOnRowIdDlg"
        :row="{ row: {}, oldRow: {}, rowMeta: {} }"
        :meta="meta"
        :row-id="routeQuery.rowId"
        :view="view"
        show-next-prev-icons
        @next="navigateToSiblingRow(NavigateDir.NEXT)"
        @prev="navigateToSiblingRow(NavigateDir.PREV)"
      />
    </Suspense>
  </div>
</template>

<style scoped lang="scss">
.nc-grid-wrapper {
  @apply h-full w-full overflow-auto;

  td,
  th {
    min-height: 41px !important;
    height: 41px !important;
    position: relative;
  }

  td:not(:first-child) > div {
    overflow: hidden;
    @apply flex items-center h-auto px-1;
  }

  table,
  td,
  th {
    @apply !border-1;
    border-collapse: collapse;
  }

  td {
    text-overflow: ellipsis;
  }

  td.active::after {
    content: '';
    position: absolute;
    z-index: 3;
    height: calc(100% + 2px);
    width: calc(100% + 2px);
    left: -1px;
    top: -1px;
    pointer-events: none;
  }

  // todo: replace with css variable
  td.active::after {
    @apply border-2 border-solid text-primary border-current bg-primary bg-opacity-5;
  }

  //td.active::before {
  //  content: '';
  //  z-index:4;
  //  @apply absolute !w-[10px] !h-[10px] !right-[-5px] !bottom-[-5px] bg-primary;
  //}
}

:deep {
  .resizer:hover,
  .resizer:active,
  .resizer:focus {
    // todo: replace with primary color
    @apply bg-blue-500/50;
    cursor: col-resize;
  }
}

.nc-grid-row {
  .nc-row-expand-and-checkbox {
    @apply w-full items-center justify-between;
  }

  .nc-expand {
    &:not(.nc-comment) {
      @apply hidden;
    }

    &.nc-comment {
      display: flex;
    }
  }

  &:hover {
    .nc-row-no.toggle {
      @apply hidden;
    }

    .nc-expand {
      @apply flex;
    }

    .nc-row-expand-and-checkbox {
      @apply flex;
    }
  }
}

.nc-grid-header {
  position: sticky;
  top: -1px;

  @apply z-1;

  &:hover {
    .nc-no-label {
      @apply hidden;
    }

    .nc-check-all {
      @apply flex;
    }
  }
}

tbody tr:hover {
  @apply bg-gray-100 bg-opacity-50;
}

.nc-required-cell {
  box-shadow: inset 0 0 2px #f00;
}
</style>
